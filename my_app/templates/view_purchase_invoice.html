
{% extends 'layouts/base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "View Purchase Invoice" %}{% endblock %}

{% block content %}

{% block page_name %}{% trans "View Purchase Invoice" %}{% endblock %}
{% block page_name2 %}{% trans "View Purchase Invoice" %}{% endblock %}

<div class="row">
  <div class="col-12">
    <div class="card mb-4">
      <div class="card-header d-flex align-items-center justify-content-between pb-0">
        <div>
          <h6 class="mb-0">{% trans "Purchase Invoice" %} #{{ invoice.id }}</h6>
          <small class="text-muted">{% trans "Added by:" %} {{ invoice.employee.first_name }} {{ invoice.employee.last_name }} &nbsp; | &nbsp; {% trans "Date:" %} {{ invoice.created_at|date:'Y-m-d H:i' }}</small>
        </div>
        <div>
          <a class="btn btn-sm btn-outline-primary" href="/print_purchase_invoice/{{ invoice.id }}" target="_blank">{% trans "Print Invoice" %}</a>
          &nbsp;
          <a class="btn btn-sm btn-outline-danger return-link" href="{% url 'purchase_return_create' invoice.id %}" data-return-label="{% trans "Purchase" %} #{{ invoice.id }}">{% trans "Return" %}</a>
        </div>
      </div>
      <div class="card-body px-0 pt-0 pb-2">
        <!-- Printable invoice area -->
        <div id="printable-invoice" class="p-4">
          <!-- Top logo centered -->
          <div class="text-center mb-3">
            <img src="{% static 'img/al-ard-profile-Banner.png' %}" alt="Al Ard company logo banner" class="invoice-top-logo" />
          </div>

          <!-- Title and metadata -->
          <div class="text-center mb-3">
            <h2 class="mb-0">{% trans "Purchase Invoice" %}</h2>
            <div class="small text-muted">{% trans "Invoice No:" %} <strong>#{{ invoice.id }}</strong> &nbsp; | &nbsp; {% trans "Date:" %} <strong>{{ invoice.created_at|date:'Y-m-d H:i' }}</strong></div>
            <div class="small text-muted">{% trans "Added by:" %} <strong>{{ invoice.employee.first_name }} {{ invoice.employee.last_name }}</strong></div>
          </div>

          <!-- Company contact (left) and invoice meta (right) for screen view -->
          <div class="d-flex justify-content-between mb-3">
            <div class="small text-muted">
              <div><strong>{% trans "الأرض للنشر والتوزيع" %}</strong></div>
              <div>{% trans "Address:" %} {% trans "البالوع , رام الله , فلسطين" %}</div>
              <div>{% trans "Phone:" %} +972-599-966535</div>
              <div>{% trans "Email:" %} info@al-ard.com</div>
            </div>
            <div class="text-end small text-muted">
              <div>{% trans "Invoice No:" %} <strong>#{{ invoice.id }}</strong></div>
              <div>{% trans "Date:" %} <strong>{{ invoice.created_at|date:'Y-m-d H:i' }}</strong></div>
              <div>{% trans "Issued by:" %} <strong>{{ invoice.employee.first_name }} {{ invoice.employee.last_name }}</strong></div>
            </div>
          </div>

          <div class="table-responsive">
            <table class="table table-sm table-striped">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Product</th>
                  <th class="text-center">Qty</th>
                  <th class="text-end">Unit Price</th>
                  <th class="text-end">Total</th>
                </tr>
              </thead>
              <tbody>
                {% if purchase_products %}
                  {% for item in purchase_products %}
                  <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>{{ item.product.product_name }}</td>
                    <td class="text-center">{{ item.quantity }}</td>
                    <td class="text-end">{{ item.unit_price }}</td>
                    <td class="text-end">{{ item.total_price }}</td>
                  </tr>
                  {% endfor %}
                {% else %}
                  <tr>
                    <td colspan="5" class="text-center text-muted">No products for this purchase.</td>
                  </tr>
                {% endif %}
              </tbody>
              <tfoot>
                <tr>
                  <td colspan="3"></td>
                  <td class="text-end fw-bold">Grand Total</td>
                  <td class="text-end fw-bold">{{ invoice.grand_total }}</td>
                </tr>
              </tfoot>
            </table>
          </div>

          <div class="invoice-notes mt-4">
            <p class="small text-muted">This purchase invoice documents products purchased. Keep this invoice for your records.</p>
          </div>

          <!-- Financial footer: VAT and signatures -->
          <div class="invoice-footer mt-4 d-flex justify-content-between align-items-start">
            <div class="vat-info small text-muted">
              <div><strong>VAT / Tax No:</strong> 12345678</div>
              <div><strong>Payment Terms:</strong> As agreed</div>
            </div>
            <div class="signatures text-end" style="min-width:300px;">
              <div class="signature-block" style="margin-bottom:40px;">
                <div class="small text-muted">_____________________________</div>
                <div class="small">Authorized Signature</div>
              </div>
              <div class="signature-block">
                <div class="small text-muted">_____________________________</div>
                <div class="small">Received by (Supplier)</div>
              </div>
            </div>
          </div>
        </div>
        <!-- end printable area -->
      </div>
    </div>
  </div>
</div>

{% block stylesheets %}
<style>
  /* Print-specific styles */
  @media print {
    body * { visibility: hidden; }
    #printable-invoice, #printable-invoice * { visibility: visible; }
    #printable-invoice { position: absolute; left: 0; top: 0; width: 100%; }
    /* Avoid table row breaks */
    table { page-break-inside: avoid; }
  }

  /* Styling for the invoice header */
  .invoice-header img{ max-height: 80px; }
  .invoice-title h3{ font-weight:700; }
  .table tfoot td{ border-top: 2px solid #dee2e6; }
  .invoice-logo img{ max-height:80px; }
</style>
{% endblock stylesheets %}

{% block javascripts %}
<script>
  function printInvoice(){
    var container = document.getElementById('printable-invoice');
    if(!container){
      alert('Printable content not found');
      return;
    }
    var content = container.outerHTML;
    var invoiceId = "{{ invoice.id }}";
    // include main CSS files so the invoice renders correctly in the new window
    var cssLinks = [
      '/static/css/argon-dashboard.min.css',
      '/static/css/nucleo-icons.css'
    ];

    var styles = `
      <style>
        body{ font-family: Arial, Helvetica, sans-serif; padding:20px; color:#212529; }
        .invoice-top-logo{ max-height:120px; display:block; margin:0 auto 10px; }
        table{ width:100%; border-collapse:collapse; }
        table th, table td{ border: 1px solid #dee2e6; padding:8px; }
        .text-end{ text-align: right; }
        .text-center{ text-align: center; }
        .fw-bold{ font-weight:700; }
        .small{ font-size:0.9rem; color:#6c757d; }
        .signature-block{ margin-top:30px; }
      </style>
    `;

    var headHtml = '<meta charset="utf-8"><title>Purchase Invoice #' + invoiceId + '</title>' + styles;
    cssLinks.forEach(function(href){ headHtml += '<link rel="stylesheet" href="' + href + '">'; });

    var html = '<!doctype html><html><head>' + headHtml + '</head><body>' + content + '</body></html>';

    var myWindow = window.open('', '_blank');
    if(!myWindow){
      alert('Please allow popups for this site to print the invoice.');
      return;
    }
    myWindow.document.open();
    myWindow.document.write(html);
    myWindow.document.close();
    myWindow.focus();
    // Allow the new window to render images/styles then print
    setTimeout(function(){
      myWindow.print();
    }, 500);
  }
</script>
{% endblock javascripts %}

{% endblock content %}






