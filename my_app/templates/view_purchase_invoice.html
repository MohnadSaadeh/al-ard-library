
{% extends 'layouts/base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "View Purchase Invoice" %}{% endblock %}

{% block content %}

{% block page_name %}{% trans "View Purchase Invoice" %}{% endblock %}

<div class="row">
  <div class="col-12">
    <div class="card mb-4">
      <div class="card-header d-flex align-items-center justify-content-between pb-0">
        <div>
          <h6 class="mb-0">{% trans "Purchase Invoice" %} #{{ invoice.id }}</h6>
          <small class="text-muted">{% trans "Added by:" %} {{ invoice.employee.first_name }} {{ invoice.employee.last_name }} &nbsp; | &nbsp; {% trans "Date:" %} {{ invoice.created_at|date:'Y-m-d H:i' }}</small>
        </div>
        <div>
          <a class="btn btn-sm btn-outline-primary" href="/print_purchase_invoice/{{ invoice.id }}" target="_blank">{% trans "Print Invoice" %}</a>
          &nbsp;
          <a class="btn btn-sm btn-outline-danger return-link" href="{% url 'purchase_return_create' invoice.id %}" data-return-label="{% trans "Purchase" %} #{{ invoice.id }}">{% trans "Return" %}</a>
        </div>
      </div>
      <div class="card-body px-0 pt-0 pb-2">
        <!-- Printable invoice area -->
        <div id="printable-invoice" class="p-4">
          <!-- Top logo centered -->
          <div class="text-center mb-3">
            <img src="{% static 'img/al-ard-profile-Banner.png' %}" alt="Al Ard company logo banner" class="invoice-top-logo" />
          </div>

          <!-- Title and metadata -->
          <div class="text-center mb-3">
            <h2 class="mb-0">{% trans "Purchase Invoice" %}</h2>
            {% if invoice.supplier %}
              <div class="small text-muted">{% trans "Supplier" %} : <strong><a href="/suppliers/{{ invoice.supplier.id }}/">{{ invoice.supplier.name }}</a></strong></div>
            {% else %}
              <div class="small text-muted">{% trans "Supplier" %} : <strong>{% trans "(none)" %}</strong></div>
            {% endif %}
            <div class="small text-muted">{% trans "Invoice No:" %} <strong>#{{ invoice.id }}</strong> &nbsp; | &nbsp; {% trans "Date:" %} <strong>{{ invoice.created_at|date:'Y-m-d H:i' }}</strong> {% if invoice.currency %}&nbsp; | &nbsp; {% trans "Currency:" %} <strong>{{ invoice.currency.code }}</strong>{% endif %}</div>
            {% comment %} <div class="small text-muted">{% trans "Added by:" %} <strong>{{ invoice.employee.first_name }} {{ invoice.employee.last_name }}</strong></div> {% endcomment %}
          </div>

          <!-- Company contact (left) and invoice meta (right) for screen view -->
          <div class="d-flex justify-content-between mb-3">
            <div class="small text-muted">
              {% if company %}
                <div><strong>{{ company.company_name }}</strong></div>
                {% if company.address %}<div>{% trans "Address:" %} {{ company.address }}</div>{% endif %}
                {% if company.registration_number %}<div>{% trans "Reg. No:" %} {{ company.registration_number }}</div>{% endif %}
                {% if company.phone %}<div>{% trans "Phone:" %} {{ company.phone }}</div>{% endif %}
                {% if company.email %}<div>{% trans "Email:" %} {{ company.email }}</div>{% endif %}
              
              {% endif %}
            </div>
            <div class="text-end small text-muted">
              <div>{% trans "Invoice No:" %} <strong>#{{ invoice.id }}</strong></div>
              <div>{% trans "Issued by:" %} <strong>{{ invoice.employee.first_name }} {{ invoice.employee.last_name }}</strong></div>
              <div>{% trans "Date:" %} <strong>{{ invoice.created_at|date:'Y-m-d H:i' }}</strong></div>
            </div>
          </div>

          <div class="table-responsive">
            <table class="table table-sm table-bordered">
              <thead>
                <tr>
                  <th>#</th>
                  <th>{% trans "Product" %}</th>
                  <th class="text-center">{% trans "Qty" %}</th>
                  <th class="text-end">{% trans "Unit Price" %}</th>
                  <th class="text-end">{% trans "Total" %}</th>
                  {% if invoice.currency and invoice.exchange_rate_to_base != 1%}<th class="text-end">{% trans "Total (Base)" %}</th>{% endif %}
                </tr>
              </thead>
              <tbody>
                {% if purchase_products %}
                  {% for item in purchase_products %}
                  <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>{{ item.product.product_name }}</td>
                    <td class="text-center">{{ item.quantity }}</td>
                    <td class="text-end">{{ item.currency.code }} {{ item.unit_price }}</td>
                    <td class="text-end">{{ item.currency.code }} {{ item.total_price }}</td>
                    {% if invoice.currency and invoice.exchange_rate_to_base != 1 %}<td class="text-end">{{ company.base_currency.code }} {{ item.total_price_base|default:"-" }}</td>{% endif %}
                  </tr>
                  {% endfor %}
                {% else %}
                  <tr>
                    <td colspan="{% if invoice.currency and invoice.exchange_rate_to_base != 1 %}6{% else %}5{% endif %}" class="text-center text-muted">{% trans "No products for this purchase." %}</td>
                  </tr>
                {% endif %}
              </tbody>
              <tfoot>
                <tr>
                  <td colspan="{% if invoice.currency and invoice.exchange_rate_to_base != 1 %}3{% else %}3{% endif %}"></td>
                  <td class="text-end fw-bold">{% trans "Grand Total" %}</td>
                  <td class="text-end fw-bold">{{ invoice.currency.code }} {{ invoice.grand_total }}</td>
                  {% if invoice.currency and invoice.exchange_rate_to_base != 1 %}<td class="text-end fw-bold">{{ company.base_currency.code }} {{ invoice.total_price_base|default:"-" }}</td>{% endif %}
                </tr>
                {% if invoice.currency and invoice.exchange_rate_to_base != 1 %}
                <tr>
                  <td colspan="{% if invoice.currency and invoice.exchange_rate_to_base != 1 %}6{% else %}5{% endif %}" class="text-end small text-muted">{% trans "Exchange Rate to Base:" %} <strong>{{ invoice.exchange_rate_to_base }}</strong></td>
                </tr> 
                {% endif %}
              </tfoot>
            </table>
          </div>

          <div class="invoice-notes mt-4">
            <p class="small text-muted">{% trans "This purchase invoice documents products purchased. Keep this invoice for your records." %}</p>
          </div>

          <!-- Financial footer: VAT and signatures -->
          <div class="invoice-footer mt-4 d-flex justify-content-between align-items-start">
            <div class="vat-info small text-muted">
              <div><strong>{% trans "VAT / Tax No:" %}</strong>  {{ company.registration_number }}</div>
              <div><strong>{% trans "Payment Terms:" %}</strong> {{ invoice.invoice_pay_method|title }}</div>
              {% if invoice.currency %}<div><strong>{% trans "Currency:" %}</strong> {{ invoice.currency.code }}</div>{% endif %}
            </div>
            <div class="signatures text-end" style="min-width:300px;">
              <div class="signature-block" style="margin-bottom:40px;">
                <div class="small text-muted">_____________________________</div>
                <div class="small">{% trans "Authorized Signature" %}</div>
              </div>
              <div class="signature-block">
                <div class="small text-muted">_____________________________</div>
                <div class="small">{% trans "Received by (Supplier)" %}</div>
              </div>
            </div>
          </div>
        </div>
        <!-- end printable area -->
      </div>
    </div>
  </div>
</div>

{% block stylesheets %}
<style>
  /* Print-specific styles */
  @media print {
    body * { visibility: hidden; }
    #printable-invoice, #printable-invoice * { visibility: visible; }
    #printable-invoice { position: absolute; left: 0; top: 0; width: 100%; }
    /* Avoid table row breaks */
    table { page-break-inside: avoid; }
  }

  /* Styling for the invoice header */
  .invoice-header img{ max-height: 80px; }
  .invoice-title h3{ font-weight:700; }
  .table tfoot td{ border-top: 2px solid #dee2e6; }
  .invoice-logo img{ max-height:80px; }
</style>
{% endblock stylesheets %}

{% block javascripts %}
<script>
  function printInvoice(){
    var container = document.getElementById('printable-invoice');
    if(!container){
  alert('{% trans "Printable content not found" %}');
      return;
    }
    var content = container.outerHTML;
    var invoiceId = "{{ invoice.id }}";
    // include main CSS files so the invoice renders correctly in the new window
    var cssLinks = [
      '/static/css/argon-dashboard.min.css',
      '/static/css/nucleo-icons.css'
    ];

    var styles = `
      <style>
        body{ font-family: Arial, Helvetica, sans-serif; padding:20px; color:#212529; }
        .invoice-top-logo{ max-height:120px; display:block; margin:0 auto 10px; }
        table{ width:100%; border-collapse:collapse; }
        table th, table td{ border: 1px solid #dee2e6; padding:8px; }
        .text-end{ text-align: right; }
        .text-center{ text-align: center; }
        .fw-bold{ font-weight:700; }
        .small{ font-size:0.9rem; color:#6c757d; }
        .signature-block{ margin-top:30px; }
      </style>
    `;

    var headHtml = '<meta charset="utf-8"><title>Purchase Invoice #' + invoiceId + '</title>' + styles;
    cssLinks.forEach(function(href){ headHtml += '<link rel="stylesheet" href="' + href + '">'; });

    var html = '<!doctype html><html><head>' + headHtml + '</head><body>' + content + '</body></html>';

    var myWindow = window.open('', '_blank');
    if(!myWindow){
      alert('{% trans "Please allow popups for this site to print the invoice." %}');
      return;
    }
    myWindow.document.open();
    myWindow.document.write(html);
    myWindow.document.close();
    myWindow.focus();
    // Allow the new window to render images/styles then print
    setTimeout(function(){
      myWindow.print();
    }, 500);
  }
</script>
{% endblock javascripts %}

{% endblock content %}






