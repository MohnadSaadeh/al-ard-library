{% extends "layouts/base.html" %}
{% load crispy_forms_tags %}
{% load i18n %}

{% block content %}
<div class="container mt-4">
    <h2>{% trans "Add / Define New Product" %}</h2>
    <form method="post">
        {% csrf_token %}

        <!-- {% trans "Product Details" %} -->
        <div class="card mb-4">
            <div class="card-header">{% trans "Product Details" %}</div>
            <div class="card-body">
                {{ form|crispy }}
            </div>
        </div>

        <!-- {% trans "Product Attributes" %} -->
        <div class="card mb-4">
            <div class="card-header">{% trans "Product Attributes" %}</div>
            <div class="card-body">
                {{ formset.management_form }}

                <div id="formset-area">
                    {% for subform in formset %}
                        <div class="border rounded p-3 mb-3 formset-form">
                            {{ subform|crispy }}
                        </div>
                    {% endfor %}
                </div>

                <!-- {% trans "Add Attribute Button" %} -->
                <button type="button" class="btn btn-sm btn-secondary" id="add-attribute">
                    {% trans "+ Add Attribute" %}
                </button>
            </div>
        </div>

        <!-- {% trans "Form Buttons" %} -->
        <button type="submit" class="btn btn-primary">ğŸ’¾ {% trans "Save Product" %}</button>
        <a href="{% url 'product_list' %}" class="btn btn-secondary">{% trans "Cancel" %}</a>
    </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const formsetArea = document.getElementById("formset-area");
    const totalForms = document.getElementById("id_attributes-TOTAL_FORMS");

    // function Ù„ØªØºÙŠÙŠØ± Ù†ÙˆØ¹ input Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ select
    function updateInputType(select) {
        const input = select.closest(".formset-form").querySelector("input[name$='attribute_value']");
        if (!input) return;
        if (select.value === "number") input.type = "number";
        else if (select.value === "date") input.type = "date";
        else input.type = "text";
    }

    // ØªØªØ¨Ø¹ Ø§Ù„ØªØºÙŠÙŠØ± Ù„Ø£ÙŠ select Ø¯Ø§Ø®Ù„ formsetArea
    formsetArea.addEventListener("change", function(e) {
        if (e.target && e.target.tagName === "SELECT" && e.target.name.includes("value_type")) {
            updateInputType(e.target);
        }
    });

    // ÙÙˆØ±Ù… ÙØ§Ø±Øº Ù„Ø¥Ø¶Ø§ÙØ© Ø®ØµØ§Ø¦Øµ Ø¬Ø¯ÙŠØ¯Ø©
    const emptyFormHtml = `{{ formset.empty_form|crispy|escapejs }}`;

    document.getElementById("add-attribute").addEventListener("click", function(e) {
        e.preventDefault();
        let formNum = parseInt(totalForms.value);
        let newForm = emptyFormHtml.replace(/__prefix__/g, formNum);
        formsetArea.insertAdjacentHTML("beforeend", newForm);
        totalForms.value = formNum + 1;
    });

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ÙˆØ¹ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙˆØ±Ù…Ø² Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    formsetArea.querySelectorAll("select[name$='value_type']").forEach(updateInputType);
});
</script>

{% endblock content %}
