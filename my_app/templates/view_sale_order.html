{% extends 'layouts/base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "View Sale Invoice" %}{% endblock %}

{% block content %}

{% block page_name %}{% trans "View Sale Invoice" %}{% endblock %}

<div class="row">
  <div class="col-12">
    <div class="card mb-4">
      <div class="p-2">
  <small class="text-muted">{% trans "Products in invoice:" %} {{ sale_products_count }}</small>
      </div>
      <div class="card-header d-flex align-items-center justify-content-between pb-0">
        <div>
          <h6 class="mb-0">{% trans "Sales Invoice" %} #{{ order.id }}</h6>
          <small class="text-muted">{% trans "Added by:" %} {{ order.employee.first_name }} {{ order.employee.last_name }} &nbsp; | &nbsp; {% trans "Date:" %} {{ order.created_at|date:'Y-m-d H:i' }}</small>
          <div class="small text-muted">
            <strong>{% trans "Customer" %}:</strong>
            {% if order.customer %}
              <a href="/customers/{{ order.customer.id }}/">{{ order.customer.name }}</a>
            {% else %}
              <em>{% trans "(none)" %}</em>
            {% endif %}
          </div>
        </div>
        <div>
          <a class="btn btn-sm btn-outline-primary" href="/print_sale_invoice/{{ order.id }}" target="_blank">{% trans "Print Invoice" %}</a>
        </div>
      </div>
      <div class="card-body px-0 pt-0 pb-2">
        <!-- Printable invoice area -->
        <div id="printable-invoice" class="p-4">
          <!-- Top logo centered -->
          <div class="text-center mb-3">
            <img src="{% static 'img/al-ard-profile-Banner.png' %}" alt="Al Ard company logo banner" class="invoice-top-logo" />
          </div>

          <!-- Title and metadata -->
            <div class="text-center mb-3">
            <h2 class="mb-0">{% trans "Sales Invoice" %}</h2>
            <div class="small text-muted">
              <strong>{% trans "Customer" %}:</strong>
              {% if order.customer %}
                <a href="/customers/{{ order.customer.id }}/">{{ order.customer.name }}</a>
              {% else %}
                <em>{% trans "(none)" %}</em>
              {% endif %}
            </div>
            <div class="small text-muted">{% trans "Invoice No:" %} <strong>#{{ order.id }}</strong> &nbsp; | &nbsp; {% trans "Date:" %} <strong>{{ order.created_at|date:'Y-m-d H:i' }}</strong>{% if order.currency %}&nbsp; | &nbsp; {% trans "Currency:" %} <strong>{{ order.currency.code }}</strong>{% endif %}</div>
            <div class="small text-muted">{% trans "Added by:" %} <strong>{{ order.employee.first_name }} {{ order.employee.last_name }}</strong></div>
          </div>

          <!-- Company contact (left) and invoice meta (right) for screen view -->
          <div class="d-flex justify-content-between mb-3">
            <div class="small text-muted">
              {% if company %}
                <div><strong>{{ company.company_name }}</strong></div>
                {% if company.address %}<div>{% trans "Address:" %} {{ company.address }}</div>{% endif %}
                {% if company.registration_number %}<div>{% trans "Reg. No:" %} {{ company.registration_number }}</div>{% endif %}
                {% if company.phone %}<div>{% trans "Phone:" %} {{ company.phone }}</div>{% endif %}
                {% if company.email %}<div>{% trans "Email:" %} {{ company.email }}</div>{% endif %}
              {% endif %}
            </div>
            <div class="text-end small text-muted">
              <div>{% trans "Invoice No:" %} <strong>#{{ order.id  }}</strong></div>
              <div> <strong>{{ order.created_at|date:'Y-m-d H:i' }}</strong></div>
              <div>{% trans "Issued by:" %} <strong>{{order.employee.first_name }} {{ order.employee.last_name }}</strong></div>
            </div>
          </div>

          <div class="table-responsive">
            <table class="table table-sm table-striped">
              <thead>
                <tr>
              <th> {% trans "No." %} </th>
              <th> {% trans "ISBN" %} </th>
              <th>{% trans "Product" %}</th>
              <th>{% trans "Quantity" %}</th>
              <th>{% trans "Unit Price" %}</th>
              <th>{% trans "Total Price" %}</th>
              <!-- if the voucher currency is different from the base currency, show the converted total base -->
                {% if order.currency and order.exchange_rate_to_base != 1 %}
                    <th>{% trans "Total (Base)" %}</th>
                {% endif %}
            </tr>
              </thead>
              <tbody>
                {% if sale_products %}
                  {% for it in sale_products %}
                  <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>{{ it.product.isbn }}</td>
                    <td>{{ it.product.product_name }}</td>
                    <td>{{ it.quantity }}</td>
                    <td>{{ it.unit_price }}</td>
                    <td>{{ it.total_price }}</td>
                    <!-- if the voucher currency is different from the base currency, show the converted total price -->
                      {% if order.currency and order.exchange_rate_to_base != 1 %}
                          <td>{{ it.total_price_base }} {{ order.currency.code }}</td>
                      {% endif %}
                  </tr>
                  {% endfor %}
                  <tr class="table-secondary fw-bold">
                    <td colspan="5" class="text-end">{% trans "Grand Total" %}</td>
                    <td>{{ order.grand_total }} {{company.base_currency.code}}</td>
                      <!-- if the voucher currency is different from the base currency, show the converted total -->
                      {% if order.currency and order.exchange_rate_to_base != 1 %}
                          <td>{{ order.total_amount_base }} {{ order.currency.code }}</td>
                      {% endif %}
                  </tr>
                {% endif %}
              </tbody>
              
            </table>
          </div>

          <div class="invoice-notes mt-4">
            <p class="small text-muted">{% trans "This sales invoice documents products sold. Keep this invoice for your records." %}</p>
          </div>

          <!-- Financial footer: VAT and signatures -->
          <div class="invoice-footer mt-4 d-flex justify-content-between align-items-start">
            <div class="vat-info small text-muted">
              <div><strong>{% trans "VAT / Tax No:" %}</strong> {{ company.registration_number }}</div>
              <div><strong>{% trans "Payment Terms:" %}</strong> {{ order.invoice_pay_method|title }}</div>
              {% if order.currency %}<div><strong>{% trans "Currency:" %}</strong> {{ order.currency.code }}</div>{% endif %}
            </div>
            <div class="signatures text-end" style="min-width:300px;">
              <div class="signature-block" style="margin-bottom:40px;">
                <div class="small text-muted">_____________________________</div>
                <div class="small">{% trans "Authorized Signature" %}</div>
              </div>
              <div class="signature-block">
                <div class="small text-muted">_____________________________</div>
                <div class="small">{% trans "Received by (Customer)" %}</div>
              </div>
            </div>
          </div>
        </div>
        <!-- end printable area -->
      </div>
    </div>
  </div>
</div>

{% block stylesheets %}
<style>
  /* Print-specific styles */
  @media print {
    body * { visibility: hidden; }
    #printable-invoice, #printable-invoice * { visibility: visible; }
    #printable-invoice { position: absolute; left: 0; top: 0; width: 100%; }
    /* Avoid table row breaks */
    table { page-break-inside: avoid; }
  }

  /* Styling for the invoice header */
  .invoice-header img{ max-height: 80px; }
  .invoice-title h3{ font-weight:700; }
  .table tfoot td{ border-top: 2px solid #dee2e6; }
  .invoice-logo img{ max-height:80px; }
</style>
{% endblock stylesheets %}

{% block javascripts %}
<script>
  function printInvoice(){
    var container = document.getElementById('printable-invoice');
    if(!container){
      alert('Printable content not found');
      return;
    }
    var content = container.outerHTML;
    var invoiceId = "{{ order.id }}";
    // include main CSS files so the invoice renders correctly in the new window
    var cssLinks = [
      '/static/css/argon-dashboard.min.css',
      '/static/css/nucleo-icons.css'
    ];

    var styles = `
      <style>
        body{ font-family: Arial, Helvetica, sans-serif; padding:20px; color:#212529; }
        .invoice-top-logo{ max-height:120px; display:block; margin:0 auto 10px; }
        table{ width:100%; border-collapse:collapse; }
        table th, table td{ border: 1px solid #dee2e6; padding:8px; }
        .text-end{ text-align: right; }
        .text-center{ text-align: center; }
        .fw-bold{ font-weight:700; }
        .small{ font-size:0.9rem; color:#6c757d; }
        .signature-block{ margin-top:30px; }
      </style>
    `;

    var headHtml = '<meta charset="utf-8"><title>Sales Invoice #' + invoiceId + '</title>' + styles;
    cssLinks.forEach(function(href){ headHtml += '<link rel="stylesheet" href="' + href + '">'; });

    var html = '<!doctype html><html><head>' + headHtml + '</head><body>' + content + '</body></html>';

    var myWindow = window.open('', '_blank');
    if(!myWindow){
      alert('Please allow popups for this site to print the invoice.');
      return;
    }
    myWindow.document.open();
    myWindow.document.write(html);
    myWindow.document.close();
    myWindow.focus();
    // Allow the new window to render images/styles then print
    setTimeout(function(){
      myWindow.print();
    }, 500);
  }
</script>
{% endblock javascripts %}

{% endblock content %}




